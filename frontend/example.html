<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จุดขายหน้าร้าน (POS) - Jewelry System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Button Press Effect */
        .btn-press:active {
            transform: scale(0.95);
        }

        /* Card Overlay Transition */
        .card-overlay {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0) 100%);
        }
    </style>
</head>

<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">

        <!-- LEFT: Product Catalog -->
        <div class="flex-1 flex flex-col bg-gray-50 border-r border-gray-200 relative">

            <!-- Search & Filter Header -->
            <div class="p-4 bg-white border-b border-gray-200 shadow-sm z-10">
                <div class="flex gap-3 mb-3">
                    <div class="relative flex-1 group">
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition"></i>
                        <input type="text" id="searchInput"
                            class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 rounded-xl outline-none transition font-medium"
                            placeholder="ค้นหาชื่อ หรือพิมพ์ SKU (เช่น C01)..." autofocus>
                        <div
                            class="absolute right-3 top-2.5 text-xs text-gray-400 bg-white border border-gray-200 px-2 py-1 rounded hidden sm:block">
                            Enter เพื่อเลือก</div>
                    </div>
                </div>

                <!-- Category Tabs -->
                <div class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
                    <button
                        class="px-4 py-1.5 bg-indigo-600 text-white rounded-full text-sm font-medium shadow-sm whitespace-nowrap transition">ทั้งหมด</button>
                    <button
                        class="px-4 py-1.5 bg-white border border-gray-200 hover:border-indigo-300 text-gray-600 hover:text-indigo-600 rounded-full text-sm font-medium whitespace-nowrap transition">สร้อยข้อมือ</button>
                    <button
                        class="px-4 py-1.5 bg-white border border-gray-200 hover:border-indigo-300 text-gray-600 hover:text-indigo-600 rounded-full text-sm font-medium whitespace-nowrap transition">ชาร์ม
                        (Charms)</button>
                    <button
                        class="px-4 py-1.5 bg-white border border-gray-200 hover:border-indigo-300 text-gray-600 hover:text-indigo-600 rounded-full text-sm font-medium whitespace-nowrap transition">สร้อยคอ</button>
                    <button
                        class="px-4 py-1.5 bg-white border border-gray-200 hover:border-orange-300 text-gray-600 hover:text-orange-600 rounded-full text-sm font-medium whitespace-nowrap transition"><i
                            class="fa-solid fa-gift mr-1"></i> เซตของขวัญ</button>
                </div>
            </div>

            <!-- Product Grid -->
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-gray-50">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="productGrid">
                    <!-- Products will be generated by JS -->
                </div>
            </div>
        </div>

        <!-- RIGHT: Cart / Bill -->
        <div class="w-[380px] bg-white flex flex-col shadow-2xl z-20 h-full border-l border-gray-200 hidden md:flex"
            id="rightPanel">
            <!-- Cart Header -->
            <div class="p-5 border-b border-gray-100 bg-white">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-receipt text-indigo-500"></i> รายการขาย
                    </h2>
                    <div class="text-xs text-gray-400 font-mono bg-gray-50 px-2 py-1 rounded">#POS-EVENT-001</div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-gray-500" id="currentDateTime"><i class="fa-regular fa-clock"></i>
                        --:--</span>
                    <button class="text-xs text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded transition"
                        onclick="clearCart()">
                        <i class="fa-solid fa-trash-can mr-1"></i> ล้างตะกร้า
                    </button>
                </div>
            </div>

            <!-- Cart Items List -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-gray-50/50" id="cartItems">
                <!-- Empty State -->
                <div class="h-full flex flex-col items-center justify-center text-gray-400 space-y-4" id="emptyCartMsg">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-cart-shopping text-3xl opacity-30"></i>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-500">ตะกร้าว่างเปล่า</p>
                        <p class="text-xs mt-1">เลือกสินค้าจากฝั่งซ้าย<br>เพื่อเริ่มขาย</p>
                    </div>
                </div>
            </div>

            <!-- Summary & Pay -->
            <div class="p-5 border-t border-gray-100 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>จำนวนสินค้า</span>
                        <span class="font-medium text-gray-800" id="totalQty">0 ชิ้น</span>
                    </div>
                    <div class="flex justify-between items-end mt-3 pt-3 border-t border-gray-100">
                        <span class="text-gray-800 font-bold text-lg">ยอดสุทธิ</span>
                        <span class="text-3xl font-bold text-indigo-600 leading-none" id="totalPrice">฿0.00</span>
                    </div>
                </div>

                <button onclick="openPaymentModal()" id="payBtn" disabled
                    class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed text-white py-4 rounded-xl font-bold text-xl shadow-lg shadow-indigo-200 transition flex items-center justify-center gap-2 btn-press group">
                    <span>ชำระเงิน</span>
                    <i class="fa-solid fa-chevron-right text-sm group-hover:translate-x-1 transition"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 1. PRODUCT DETAIL MODAL (สำหรับดูข้อมูลละเอียด) -->
    <div id="productDetailModal"
        class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div
            class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200 flex flex-col md:flex-row max-h-[85vh]">

            <!-- Product Image Section -->
            <div class="md:w-1/2 bg-gray-100 flex items-center justify-center p-8 relative">
                <button onclick="closeDetailModal()"
                    class="absolute top-4 left-4 bg-white/80 hover:bg-white text-gray-600 w-8 h-8 rounded-full flex items-center justify-center transition md:hidden">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <i class="fa-solid fa-gem text-9xl text-gray-300 drop-shadow-md" id="detailIcon"></i>
                <img id="detailImage" src="" class="absolute inset-0 w-full h-full object-cover hidden"
                    alt="Product Image">

                <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur-sm px-3 py-1.5 rounded-lg shadow-sm">
                    <span class="text-xs font-bold text-gray-500 uppercase">Stock</span>
                    <div class="text-lg font-bold text-gray-800 leading-none" id="detailStock">0</div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="md:w-1/2 p-8 flex flex-col overflow-y-auto">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2.5 py-1 rounded-md uppercase tracking-wide"
                        id="detailCategory">Category</span>
                    <button onclick="closeDetailModal()"
                        class="text-gray-400 hover:text-gray-600 transition hidden md:block"><i
                            class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-1 leading-tight" id="detailName">Product Name</h2>
                <div class="font-mono text-sm text-gray-500 mb-4 bg-gray-50 inline-block px-2 py-0.5 rounded border border-gray-100"
                    id="detailSku">SKU-001</div>

                <div class="text-3xl font-bold text-indigo-600 mb-6" id="detailPrice">฿0.00</div>

                <div class="space-y-4 mb-6 text-sm text-gray-600 flex-1">
                    <div>
                        <h4 class="font-bold text-gray-800 mb-1">รายละเอียดสินค้า:</h4>
                        <p id="detailDesc">Lorem ipsum dolor sit amet.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <h4 class="font-bold text-gray-800 text-xs mb-1 uppercase">วัสดุ (Material)</h4>
                            <p id="detailMaterial">-</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <h4 class="font-bold text-gray-800 text-xs mb-1 uppercase">ขนาด (Size)</h4>
                            <p id="detailSize">-</p>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100 mt-auto">
                    <button id="detailAddToCartBtn"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition flex items-center justify-center gap-2 btn-press">
                        <span>เพิ่มลงตะกร้า</span>
                        <i class="fa-solid fa-cart-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. PAYMENT MODAL -->
    <div id="paymentModal"
        class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200"
            id="payModalContent">
            <!-- Modal Header -->
            <div class="bg-indigo-600 p-6 text-white text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-coins text-6xl"></i></div>
                <h3 class="text-sm font-medium opacity-90 uppercase tracking-wide mb-1">ยอดที่ต้องชำระ</h3>
                <div class="text-5xl font-bold tracking-tight" id="modalTotal">฿0.00</div>
            </div>

            <div class="p-6">
                <p class="text-sm text-gray-500 mb-4 font-medium flex items-center gap-2">
                    <i class="fa-solid fa-wallet text-indigo-500"></i> เลือกวิธีชำระเงิน:
                </p>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button
                        class="payment-option selected p-4 border-2 border-indigo-500 bg-indigo-50 text-indigo-700 rounded-xl flex flex-col items-center gap-2 transition ring-2 ring-transparent outline-none relative"
                        onclick="selectPayment(this, 'cash')">
                        <div class="absolute top-2 right-2 text-indigo-600"><i class="fa-solid fa-circle-check"></i>
                        </div>
                        <i class="fa-solid fa-money-bill-wave text-3xl mb-1"></i>
                        <span class="font-bold text-sm">เงินสด</span>
                    </button>
                    <button
                        class="payment-option p-4 border-2 border-gray-100 bg-white text-gray-500 rounded-xl flex flex-col items-center gap-2 hover:border-gray-300 hover:bg-gray-50 transition outline-none"
                        onclick="selectPayment(this, 'transfer')">
                        <i class="fa-solid fa-qrcode text-3xl mb-1"></i>
                        <span class="font-bold text-sm">โอนเงิน / QR</span>
                    </button>
                </div>

                <div class="flex gap-3 pt-2">
                    <button onclick="closePaymentModal()"
                        class="w-1/3 py-3.5 border border-gray-300 text-gray-600 rounded-xl font-bold hover:bg-gray-50 transition">ยกเลิก</button>
                    <button onclick="confirmPayment()"
                        class="flex-1 py-3.5 bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition flex items-center justify-center gap-2">
                        ยืนยันการขาย <i class="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. DAILY SUMMARY MODAL -->
    <div id="dailySummaryModal"
        class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200"
            id="summaryModalContent">
            <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-chart-pie text-indigo-600 mr-2"></i>
                    สรุปยอดขายวันนี้</h3>
                <button onclick="closeDailySummary()" class="text-gray-400 hover:text-gray-600 transition"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="text-sm text-gray-500 mb-1">ยอดขายรวมทั้งหมด</div>
                    <div class="text-4xl font-bold text-indigo-700" id="summaryTotalSales">฿0.00</div>
                    <div class="text-xs text-gray-400 mt-1" id="summaryDate">Date: --/--/----</div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100 text-center">
                        <div class="text-green-600 text-2xl mb-1"><i class="fa-solid fa-money-bill-wave"></i></div>
                        <div class="text-xs text-gray-500 font-bold uppercase">เงินสด</div>
                        <div class="text-lg font-bold text-gray-800" id="summaryCash">฿0.00</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center">
                        <div class="text-blue-600 text-2xl mb-1"><i class="fa-solid fa-qrcode"></i></div>
                        <div class="text-xs text-gray-500 font-bold uppercase">เงินโอน</div>
                        <div class="text-lg font-bold text-gray-800" id="summaryTransfer">฿0.00</div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-gray-700">จำนวนบิลที่ขายได้</span>
                        <span class="font-bold text-gray-800" id="summaryBillCount">0 บิล</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-700">สินค้าที่ขายออกไป</span>
                        <span class="font-bold text-gray-800" id="summaryItemCount">0 ชิ้น</span>
                    </div>
                </div>

                <button onclick="closeDailySummary()"
                    class="w-full mt-6 bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-50 transition">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ข้อมูลสินค้า (Mockup Data) ---
        // เพิ่มรายละเอียดสินค้า (Description, Material, Size, Stock) เพื่อใช้ตอบลูกค้า
        const productsDB = [
            {
                sku: 'N01-CHAIN',
                name: 'สร้อยข้อมือเงินแท้ ลายโซ่',
                price: 590,
                category: 'Bracelet',
                stock: 15,
                icon: 'fa-gem',
                color: 'text-indigo-200',
                desc: 'สร้อยข้อมือเงินแท้ 925 ดีไซน์โซ่คลาสสิก ใส่ได้ทุกโอกาส ทนทาน ไม่ลอกไม่ดำ',
                material: 'Sterling Silver 925',
                size: 'Free Size (ปรับระดับได้ 16-19 ซม.)'
            },
            {
                sku: 'C01-RED',
                name: 'ชาร์มหัวใจ (สีแดง)',
                price: 150,
                category: 'Charm',
                stock: 42,
                icon: 'fa-heart',
                color: 'text-red-300',
                desc: 'ชาร์มรูปหัวใจลงยาสีแดงสดใส ขอบเงินแท้ ใช้สำหรับตกแต่งสร้อยข้อมือ',
                material: 'Silver 925, Enamel',
                size: '1.2 x 1.2 ซม.'
            },
            {
                sku: 'C02-SLV',
                name: 'ชาร์มดาว (สีเงิน)',
                price: 150,
                category: 'Charm',
                stock: 30,
                icon: 'fa-star',
                color: 'text-yellow-300',
                desc: 'ชาร์มรูปดาว 5 แฉก ผิวขัดเงา ให้ความรู้สึกเรียบหรู มินิมอล',
                material: 'Silver 925',
                size: '1.0 x 1.0 ซม.'
            },
            {
                sku: 'SET-VAL01',
                name: 'Set Valentine A',
                price: 990,
                category: 'Bundle',
                stock: 8,
                icon: 'fa-gift',
                color: 'text-orange-300',
                desc: 'เซตของขวัญวาเลนไทน์ ประกอบด้วย สร้อยข้อมือ 1 เส้น และ ชาร์มหัวใจ 2 ชิ้น พร้อมกล่องของขวัญ',
                material: 'Mixed',
                size: 'Box Set'
            },
            {
                sku: 'B02-PEARL',
                name: 'สร้อยข้อมือมุกแท้',
                price: 1290,
                category: 'Bracelet',
                stock: 5,
                icon: 'fa-circle',
                color: 'text-gray-200',
                desc: 'สร้อยข้อมือร้อยมุกน้ำจืดแท้ คัดเกรด A แวววาว สีขาวนวล',
                material: 'Freshwater Pearl, Silver Clasp',
                size: '17 ซม.'
            }
        ];

        // --- 2. ตัวแปรระบบ ---
        let cart = [];
        let dailySummary = {
            totalSales: 0,
            billCount: 0,
            itemCount: 0,
            cash: 0,
            transfer: 0
        };
        let currentPaymentMethod = 'cash';

        // --- 3. เริ่มต้นทำงาน (Init) ---
        window.onload = function () {
            renderProductGrid(productsDB);
            updateDateTime();
            setInterval(updateDateTime, 60000);
            document.getElementById('summaryDate').innerText = 'Date: ' + new Date().toLocaleDateString('th-TH');
        };

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').innerHTML = `<i class="fa-regular fa-clock"></i> ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}`;
        }

        // --- 4. ฟังก์ชันแสดงสินค้า ---
        function renderProductGrid(items) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl shadow-sm border border-gray-200 hover:border-indigo-500 hover:shadow-md transition cursor-pointer flex flex-col h-full btn-press group relative';

                // การคลิกการ์ดหลัก = เพิ่มลงตะกร้าทันที (เพื่อความเร็ว)
                card.onclick = (e) => {
                    // ป้องกัน event ชนกัน ถ้ากดปุ่ม info
                    if (e.target.closest('.info-btn')) return;
                    addToCart(item.sku);
                };

                card.innerHTML = `
                    <div class="aspect-square bg-gray-100 rounded-lg mb-3 flex items-center justify-center relative overflow-hidden">
                        <i class="fa-solid ${item.icon} text-4xl group-hover:scale-110 transition duration-300 ${item.color}"></i>
                        <div class="absolute top-2 right-2 bg-white/90 px-2 py-0.5 rounded text-xs font-bold text-gray-800 shadow-sm">฿${item.price}</div>
                        
                        <!-- ปุ่มดูรายละเอียด (Info Button) -->
                        <button class="info-btn absolute bottom-2 left-2 w-8 h-8 bg-white/90 hover:bg-indigo-600 hover:text-white text-gray-500 rounded-full shadow-sm flex items-center justify-center transition z-10" 
                            onclick="openDetailModal('${item.sku}')" title="ดูรายละเอียด">
                            <i class="fa-solid fa-info"></i>
                        </button>
                    </div>
                    <div class="mt-auto">
                        <div class="flex justify-between items-center mb-1">
                            <div class="text-[10px] uppercase tracking-wider text-indigo-600 font-bold">${item.category}</div>
                            <div class="text-[10px] text-gray-400">Stock: ${item.stock}</div>
                        </div>
                        <h3 class="font-medium text-gray-800 text-sm leading-tight mb-1 line-clamp-2">${item.name}</h3>
                        <div class="text-xs text-gray-400 font-mono bg-gray-50 inline-block px-1 rounded">${item.sku}</div>
                    </div>
                    <!-- Overlay Effect -->
                    <div class="absolute inset-0 bg-indigo-600/5 rounded-xl opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none"></div>
                `;
                grid.appendChild(card);
            });
        }

        // Search Filter
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const term = e.target.value.toUpperCase();
            const filtered = productsDB.filter(p => p.sku.includes(term) || p.name.toUpperCase().includes(term));
            renderProductGrid(filtered);
        });

        // Enter to Add
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const term = this.value.toUpperCase();
                const exactMatch = productsDB.find(p => p.sku === term);
                if (exactMatch) {
                    addToCart(exactMatch.sku);
                    this.value = '';
                    renderProductGrid(productsDB); // Reset grid
                }
            }
        });

        // --- 5. ฟังก์ชันตะกร้าสินค้า (Cart) ---
        function addToCart(sku) {
            const product = productsDB.find(p => p.sku === sku);

            // เช็คสต็อก
            const currentInCart = cart.find(c => c.sku === sku)?.qty || 0;
            if (currentInCart >= product.stock) {
                alert('สินค้าหมดสต็อก! (หรืออยู่ในตะกร้าแล้ว)');
                return;
            }

            const existing = cart.find(item => item.sku === sku);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('ยืนยันการล้างตะกร้า?')) {
                cart = [];
                renderCart();
            }
        }

        function changeQty(index, delta) {
            const item = cart[index];
            const product = productsDB.find(p => p.sku === item.sku);

            if (delta > 0 && item.qty >= product.stock) {
                alert('จำนวนเกินสต็อกที่มี');
                return;
            }

            if (item.qty + delta > 0) {
                item.qty += delta;
            } else {
                if (confirm('ลบรายการนี้ออกจากตะกร้า?')) cart.splice(index, 1);
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const emptyMsg = document.getElementById('emptyCartMsg');
            const payBtn = document.getElementById('payBtn');

            container.innerHTML = '';

            if (cart.length === 0) {
                container.appendChild(emptyMsg);
                emptyMsg.classList.remove('hidden');
                payBtn.disabled = true;
                updateSummary(0, 0);
                return;
            }

            emptyMsg.classList.add('hidden');
            payBtn.disabled = false;

            let totalQty = 0;
            let totalPrice = 0;

            cart.forEach((item, index) => {
                totalQty += item.qty;
                totalPrice += (item.price * item.qty);

                const div = document.createElement('div');
                div.className = 'flex justify-between items-start p-3 bg-white border border-gray-200 rounded-xl shadow-sm group mb-2 hover:border-indigo-300 transition';
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="text-sm font-bold text-gray-800 leading-tight mb-1 line-clamp-1">${item.name}</div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] text-gray-500 font-mono bg-gray-100 px-1 rounded">${item.sku}</span>
                        </div>
                        <div class="text-sm font-bold text-indigo-600">฿${item.price.toLocaleString()}</div>
                    </div>
                    <div class="flex flex-col items-end gap-2 pl-2">
                        <div class="flex items-center border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                            <button onclick="changeQty(${index}, -1)" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-white rounded-l-lg transition text-xs font-bold">-</button>
                            <span class="text-sm font-bold w-6 text-center text-gray-800">${item.qty}</span>
                            <button onclick="changeQty(${index}, 1)" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:text-indigo-600 hover:bg-white rounded-r-lg transition text-xs font-bold">+</button>
                        </div>
                        <button onclick="removeFromCart(${index})" class="text-xs text-gray-300 hover:text-red-500 transition p-1"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });

            updateSummary(totalQty, totalPrice);
        }

        function updateSummary(qty, price) {
            document.getElementById('totalQty').innerText = qty + ' ชิ้น';
            document.getElementById('totalPrice').innerText = '฿' + price.toLocaleString();
            document.getElementById('modalTotal').innerText = '฿' + price.toLocaleString();
        }

        // --- 6. Product Detail Modal Logic ---
        const detailModal = document.getElementById('productDetailModal');

        function openDetailModal(sku) {
            const product = productsDB.find(p => p.sku === sku);
            if (!product) return;

            // Populate Data
            document.getElementById('detailName').innerText = product.name;
            document.getElementById('detailSku').innerText = product.sku;
            document.getElementById('detailPrice').innerText = '฿' + product.price.toLocaleString();
            document.getElementById('detailCategory').innerText = product.category;
            document.getElementById('detailStock').innerText = product.stock;
            document.getElementById('detailDesc').innerText = product.desc;
            document.getElementById('detailMaterial').innerText = product.material;
            document.getElementById('detailSize').innerText = product.size;

            // Icon handling (Mock Image)
            const iconElem = document.getElementById('detailIcon');
            iconElem.className = `fa-solid ${product.icon} text-9xl ${product.color} drop-shadow-md`;

            // Setup Add Button inside modal
            const btn = document.getElementById('detailAddToCartBtn');
            btn.onclick = function () {
                addToCart(sku);
                closeDetailModal();
            };

            // Show Modal
            detailModal.classList.remove('hidden');
            setTimeout(() => {
                detailModal.classList.remove('opacity-0');
                detailModal.children[0].classList.remove('scale-95');
                detailModal.children[0].classList.add('scale-100');
            }, 10);
        }

        function closeDetailModal() {
            detailModal.classList.add('opacity-0');
            detailModal.children[0].classList.remove('scale-100');
            detailModal.children[0].classList.add('scale-95');
            setTimeout(() => {
                detailModal.classList.add('hidden');
            }, 200);
        }

        // --- 7. Payment Modal Logic ---
        const payModal = document.getElementById('paymentModal');
        const payContent = document.getElementById('payModalContent');

        function openPaymentModal() {
            payModal.classList.remove('hidden');
            setTimeout(() => {
                payModal.classList.remove('opacity-0');
                payContent.classList.remove('scale-95');
                payContent.classList.add('scale-100');
            }, 10);
        }

        function closePaymentModal() {
            payModal.classList.add('opacity-0');
            payContent.classList.remove('scale-100');
            payContent.classList.add('scale-95');
            setTimeout(() => {
                payModal.classList.add('hidden');
            }, 200);
        }

        function selectPayment(btn, method) {
            currentPaymentMethod = method;
            document.querySelectorAll('.payment-option').forEach(el => {
                el.classList.remove('border-indigo-500', 'bg-indigo-50', 'text-indigo-700', 'selected');
                el.classList.add('border-gray-100', 'bg-white', 'text-gray-500');
                if (el.querySelector('.absolute')) el.querySelector('.absolute').remove();
            });
            btn.classList.remove('border-gray-100', 'bg-white', 'text-gray-500');
            btn.classList.add('border-indigo-500', 'bg-indigo-50', 'text-indigo-700', 'selected');
            const checkIcon = document.createElement('div');
            checkIcon.className = 'absolute top-2 right-2 text-indigo-600';
            checkIcon.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
            btn.appendChild(checkIcon);
        }

        function confirmPayment() {
            const btn = document.querySelector('#paymentModal button.bg-green-600');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังบันทึก...';
            btn.disabled = true;

            setTimeout(() => {
                // 1. ตัดสต็อกจริง (ใน Mock Data)
                let grandTotal = 0;
                let totalItems = 0;

                cart.forEach(cartItem => {
                    const product = productsDB.find(p => p.sku === cartItem.sku);
                    if (product) {
                        product.stock -= cartItem.qty; // Deduct stock
                    }
                    grandTotal += (cartItem.price * cartItem.qty);
                    totalItems += cartItem.qty;
                });

                // 2. บันทึกยอดขายรายวัน (Update Daily Summary)
                dailySummary.totalSales += grandTotal;
                dailySummary.billCount += 1;
                dailySummary.itemCount += totalItems;
                if (currentPaymentMethod === 'cash') {
                    dailySummary.cash += grandTotal;
                } else {
                    dailySummary.transfer += grandTotal;
                }

                // 3. Reset UI
                alert('✅ ขายสำเร็จ! (ตัดสต็อกเรียบร้อย)');
                cart = [];
                renderCart();
                renderProductGrid(productsDB); // Re-render grid to show updated stock
                closePaymentModal();
                btn.innerHTML = originalHTML;
                btn.disabled = false;

            }, 800);
        }

        // --- 8. Daily Summary Modal Logic ---
        const summaryModal = document.getElementById('dailySummaryModal');
        const summaryContent = document.getElementById('summaryModalContent');

        function openDailySummary() {
            // Update Data before showing
            document.getElementById('summaryTotalSales').innerText = '฿' + dailySummary.totalSales.toLocaleString();
            document.getElementById('summaryCash').innerText = '฿' + dailySummary.cash.toLocaleString();
            document.getElementById('summaryTransfer').innerText = '฿' + dailySummary.transfer.toLocaleString();
            document.getElementById('summaryBillCount').innerText = dailySummary.billCount + ' บิล';
            document.getElementById('summaryItemCount').innerText = dailySummary.itemCount + ' ชิ้น';

            summaryModal.classList.remove('hidden');
            setTimeout(() => {
                summaryModal.classList.remove('opacity-0');
                summaryContent.classList.remove('scale-95');
                summaryContent.classList.add('scale-100');
            }, 10);
        }

        function closeDailySummary() {
            summaryModal.classList.add('opacity-0');
            summaryContent.classList.remove('scale-100');
            summaryContent.classList.add('scale-95');
            setTimeout(() => {
                summaryModal.classList.add('hidden');
            }, 200);
        }

    </script>
</body>

</html>